<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Living Testament Agency</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- All your HTML structure (header, sections, footer) remains exactly the same -->
  <header> <nav class="navbar"> <div class="logo">Living Testament Agency</div> <ul class="nav-links"> <li><a href="#about">About</a></li> <li><a href="#jobs">Jobs</a></li> <li><a href="#enquiry">Enquiry</a></li> </ul> </nav> </header>
  <section class="hero"> <h1 id="heroTitle">Welcome to Living Testament Agency</h1> <p id="heroTagline">Sourcing trusted workers for Singapore</p> </section>
  <section class="services"> <h2>Our Services</h2> <div class="service-grid"> <div class="service-card">✔️ Domestic Helpers</div> <div class="service-card">✔️ Office Cleaners</div> <div class="service-card">✔️ Hospitality Staff</div> </div> </section>
  <section id="about"> <h2>About Us</h2> <p id="aboutText"></p> <p><strong>Email:</strong> <span id="contactEmail"></span></p> <p><strong>Phone/WhatsApp:</strong> <span id="phone"></span></p> <p><strong>Address:</strong> <span id="address"></span></p> <p><strong>Owner:</strong> <span id="owner"></span> (<span id="role"></span>)</p> </section>
  <section id="jobs"> <h2>Available Jobs</h2> <div id="jobsList" class="job-grid">Loading jobs...</div> </section>
  <div id="jobAppModal" class="modal"> <div class="modal-content"> <span id="closeModal">&times;</span> <h2>Job Application</h2> <form id="jobAppForm"> <input type="hidden" name="Position" id="jobPosition"> <input type="hidden" name="Country" id="jobCountry"> <input type="hidden" name="JobID" id="jobId"> <div><strong>Position: </strong><span id="modalPosition"></span></div> <div><strong>Country: </strong><span id="modalCountry"></span></div> <div><strong>Salary: </strong><span id="modalSalary"></span></div> <hr> <input type="text" name="Applicant_Name" placeholder="Your Name" required> <input type="tel" name="Applicant_Phone" placeholder="Phone Number" required> <input type="email" name="Applicant_Email" placeholder="Email" required> <textarea name="Applicant_Message" placeholder="Why are you suitable for this job?" required></textarea> <button type="submit">Apply Now</button> </form> <p id="jobAppStatus"></p> </div> </div>
  <section id="enquiry"> <h2>Send an Enquiry</h2> <form id="enquiryForm"> <input type="text" name="Full_Name" placeholder="Full Name" required> <input type="email" name="Email" placeholder="Email Address" required> <input type="tel" name="Phone" placeholder="Phone Number" required> <select name="Enquiry_Type" required> <option value="" disabled selected>-- Select Enquiry Type --</option> <option value="Domestic Helper">Domestic Helper Enquiry</option> <option value="Office Cleaning">Office Cleaning Enquiry</option> <option value="Hospitality Staff">Hospitality Staff Enquiry</option> <option value="General Question">General Question</option> </select> <textarea name="Message" placeholder="Your message..." required></textarea> <button type="submit">Submit</button> </form> <p id="enquiryStatus"></p> </section>
  <footer> <p id="footerText"></p> </footer>

  <script>
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyw_6VvW5ehMubzVRjobPla5Z-VuG6gB9iP0wh9HJNb1fGvZEmE1IZbcOlh1huqSb1q/exec"; // Make sure this is your latest deployment URL

    //-- NEW HELPER FUNCTION to reliably parse DD/MM/YYYY dates from the sheet
    function parseDMYDate(dateString) {
      const parts = dateString.split('/');
      if (parts.length !== 3) return null;
      // Note: month is 0-indexed in JavaScript (0=Jan, 11=Dec)
      return new Date(parts[2], parts[1] - 1, parts[0]);
    }

    //-- NEW FUNCTION to apply theme and set the welcome message
    function applyTheme(themes, aboutData) {
      const today = new Date();
      today.setHours(0, 0, 0, 0); // Normalize for accurate date comparison
      let themeApplied = false;

      if (themes && themes.length > 0) {
        for (const theme of themes) {
          const startDate = parseDMYDate(theme.StartDate);
          const endDate = parseDMYDate(theme.EndDate);

          if (startDate && endDate && today >= startDate && today <= endDate) {
            // Convert "ThemeName" to a CSS class, e.g., "MooncakeFestival" -> "theme-mooncakefestival"
            const cssClass = `theme-${theme.ThemeName.replace(/\s+/g, '').toLowerCase()}`;
            document.body.classList.add(cssClass);
            
            // Update the hero title with the WelcomeMessage
            document.getElementById("heroTitle").textContent = theme.WelcomeMessage;
            
            themeApplied = true;
            console.log(`Theme applied: ${theme.ThemeName}`);
            break; // Apply only the first matching theme
          }
        }
      }

      //-- If no theme was applied, use the default company name from the "About" sheet
      if (!themeApplied) {
        document.getElementById("heroTitle").textContent = aboutData.CompanyName;
      }
    }

    async function loadData() {
      try {
        const res = await fetch(APPS_SCRIPT_URL);
        const data = await res.json();
        const about = data.About[0];

        //-- MODIFIED: Call the new theme function FIRST
        applyTheme(data.Themes, about);
        
        //-- Set the tagline (the main hero title is now handled by the theme function)
        document.getElementById("heroTagline").textContent = about.Slogan;
        
        //-- The rest of your working code is UNCHANGED
        document.getElementById("aboutText").textContent = about.AboutCompany;
        document.getElementById("contactEmail").textContent = about.EmailAddress;
        document.getElementById("phone").textContent = about.Whatsapp || about.ContactNuimber;
        document.getElementById("address").textContent = about.Address;
        document.getElementById("owner").textContent = about.Owner;
        document.getElementById("role").textContent = about.Role;
        document.getElementById("footerText").textContent = about.Footer;

        const jobsDiv = document.getElementById("jobsList");
        jobsDiv.innerHTML = "";
        data.Jobs.forEach((job, idx) => {
          const card = document.createElement("div");
          card.className = "job-card";
          card.innerHTML = `<h3>${job.Position}</h3><p><strong>Country:</strong> ${job.Worker_Country}</p><p><strong>Gender:</strong> ${job.Gender}</p><p><strong>Age:</strong> ${job.Age_Range}</p><p><strong>Salary:</strong> SGD ${job.Monthly_Salary_SGD}</p><p><strong>Rest Day:</strong> ${job.Rest_Day}</p><p>${job.Job_Description}</p><button class="applyBtn" data-idx="${idx}">Apply</button>`;
          jobsDiv.appendChild(card);
        });

        document.querySelectorAll('.applyBtn').forEach(btn => {
          btn.addEventListener('click', function() {
            const job = data.Jobs[this.dataset.idx];
            openJobAppModal(job, this.dataset.idx);
          });
        });
        window.jobsData = data.Jobs;
      } catch (err) {
        console.error("Failed to load data:", err);
      }
    }
    
    //-- All the other functions (modal, form submissions, etc.) are UNCHANGED
    function openJobAppModal(job, idx) {
      document.getElementById('jobPosition').value = job.Position;
      document.getElementById('jobCountry').value = job.Worker_Country;
      document.getElementById('jobId').value = idx;
      document.getElementById('modalPosition').textContent = job.Position;
      document.getElementById('modalCountry').textContent = job.Worker_Country;
      document.getElementById('modalSalary').textContent = "SGD " + job.Monthly_Salary_SGD;
      document.getElementById('jobAppStatus').textContent = "";
      document.getElementById('jobAppModal').style.display = "block";
    }
    document.getElementById('closeModal').onclick = function() {
      document.getElementById('jobAppModal').style.display = "none";
    };
    window.onclick = function(event) {
      const modal = document.getElementById('jobAppModal');
      if (event.target == modal) {
        modal.style.display = "none";
      }
    };
    document.getElementById("jobAppForm").addEventListener("submit", async e => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const obj = {};
      formData.forEach((v,k) => obj[k] = v);
      try {
        await fetch(APPS_SCRIPT_URL, { method: "POST", body: JSON.stringify({ type: "job_application", data: obj }) });
        document.getElementById("jobAppStatus").textContent = "Application submitted successfully!";
        e.target.reset();
      } catch {
        document.getElementById("jobAppStatus").textContent = "Error submitting application.";
      }
    });
    document.getElementById("enquiryForm").addEventListener("submit", async e => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const obj = {};
      formData.forEach((v,k) => obj[k] = v);
      try {
        await fetch(APPS_SCRIPT_URL, { method: "POST", body: JSON.stringify({ type: "enquiry", data: obj }) });
        document.getElementById("enquiryStatus").textContent = "Enquiry sent successfully!";
        e.target.reset();
      } catch {
        document.getElementById("enquiryStatus").textContent = "Error sending enquiry.";
      }
    });
    
    loadData();
  </script>
</body>
</html>
